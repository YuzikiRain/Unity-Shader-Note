## gamma校正过程

-   假设实际物理世界中图像的像素值为x

-   经过gamma编码（提亮）进行了$1/2.2$次幂的计算，保存在硬盘中、图像编辑器下编辑显示时内存中的值实际为$x^{1/2.2}$，
-   经过gamma解码（压暗）进行了$2.2$次幂的计算，从显示器显示出来的值为x

![image-20221231150947134](https://fastly.jsdelivr.net/gh/YuzikiRain/ImageBed/img/202212311509208.png)

## 为什么需要gamma校正

-   历史原因：老旧的CRT显示器在输入线性的电压时，产生的亮度不是线性的，设物理像素颜色为x，则显示器显示值是$x^{2.2}$。假如将图像的颜色直接一一对应地存储起来（线性映射），在显示器上查看时会感觉图像变暗了（相比于人眼直接观察该物理像素）。注意，这里和人眼对暗部变化比亮部更加敏感没有关系。
    为了兼容这些年来已经产生了的大量（提亮了之后存储的）图像，即使是液晶显示器也需要对这些图像进行压暗处理。
-   人眼对暗部变化比亮部更加敏感：更多的空间用于存储对人眼更敏感更重要的暗部数据

## 人眼对暗部变化比亮部更加敏感

（上方的图）中间的0.5才是人眼认为的中灰色（美术中灰色），更符合人的直观感受，因此美术创作者一般在创造作品时也是以该标准来制作的。如果是以物理中灰色来创作，人眼会感觉暗部变化过快。

出于节约带宽、硬盘空间的考虑，目前大部分图像都是以8位图（4个颜色分量共32bit）存储，而不是32位图，对于暗部变化的细节没有足够的空间来表示。

如果不做该处理而是简单地线性映射，虽然颜色值是线性变化的，但是对于人眼来看，会觉得亮部没啥区别，但大部分暗部变化细节丢失了（没有足够空间），，出现一些区域全黑、灰阶断层等现象。

因此需要使用gamma校正来进行一个更合理的数据处理，将大部分亮部的存储空间让给了暗部

如果是32位图，可以不使用该方法。

### 例子

假设实际物理世界中图像的像素值为0.5（下方的图）

经过gamma编码（提亮）变为0.73（上方的图），该值作为图片像素数据保存于硬盘或作为在Unity编辑器的调色板上查看的显示值（PS的颜色管理较为复杂不做介绍）

经过gamma解码（压暗），从显示器显示出来的值为0.5

该像素进入人眼时，人脑会这样处理：取出上方的图，查找图上颜色等同于该像素值时的位置，得到约0.73，因此认为该值是0.73。再看一眼Unity编辑器调色板上显示值，也是0.73。

也就是说，实际上在观察、编辑、保存图像时，我们都是在和提亮了的图像打交道。

![img](https://fastly.jsdelivr.net/gh/YuzikiRain/ImageBed/img/202212311626461.png)

## Unity中的gamma

一般来说，输入的带有物理世界颜色信息的漫反射纹理等，都是经过gamma编码（提亮）的，而那些。

Unity存在2种颜色空间设置，正确的工作流如下

### gamma

纹理的sRGB选项是没用的

-   使用纹理采样函数采样提亮了的图像，得到的值不做任何处理，因此是提亮了的
-   FrameBuffer输出时也不做任何处理，和上一步一样，也是提亮了的
-   显示器在显示颜色时，进行gamma解码（压暗），最终得到的是实际物理世界中的值。

### linear

#### 勾选sRGB

需要保证输入的纹理是sRGB空间下的（提亮的），否则如果输入的纹理是线性空间下的则最终结果会变暗

-   对采样的纹理做pow2.2的gamma校正（压暗），将输入从sRGB空间转换到线性空间。
-   FrameBuffer输出时做一次pow0.45的gamma校正（提亮），将结果从线性空间转换到sRGB颜色空间。
-   显示器在显示颜色时，进行gamma解码（压暗），最终得到的是线性空间的值。

#### 不勾选sRGB

需要保证输入的纹理是线性空间下的（未提亮的），否则如果输入的纹理是sRGB空间下的则最终结果会变暗

-   认为该纹理已经是线性空间下的了，对采样的纹理不做处理。
-   FrameBuffer输出时做一次pow0.45的gamma校正（提亮），将结果从线性空间转换到sRGB颜色空间。
-   显示器在显示颜色时，进行gamma解码（压暗），最终得到的是线性空间的值。

## 如何判断是在线性还是sRGB空间下

如果应用了滤镜-高斯模糊，不同图层的红绿色交界处为黑色则是sRGB空间，黄色则是线性空间

![image-20221231160240174](https://fastly.jsdelivr.net/gh/YuzikiRain/ImageBed/img/202212311602252.png)

![image-20221231150803315](https://fastly.jsdelivr.net/gh/YuzikiRain/ImageBed/img/202212311508816.png)

## 参考

-   [Unity - Manual: Color space (unity3d.com)](https://docs.unity3d.com/Manual/LinearLighting.html)
-   [Gamma Correction/Gamma校正/灰度校正/亮度校正(已更正) - 部分 DCC 中的线性工作流配置_Jave.Lin的博客-CSDN博客_degamma](https://blog.csdn.net/linjf520/article/details/122201009)
-   [Unity & PS Linear Workflow - Unity 和 PS 的线性工作流实践 - 简单配置示例_Jave.Lin的博客-CSDN博客_unity美术线性工作流](https://blog.csdn.net/linjf520/article/details/126672005)