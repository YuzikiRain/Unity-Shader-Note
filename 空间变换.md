## 观察空间到裁剪空间到NDC

从观察空间变换到裁剪空间的矩阵被称为裁剪矩阵或投影矩阵，但实际的投影（从三维到二维）发生在NDC坐标空间上，经过透视除法和屏幕映射（视口变换）变换到屏幕空间上

### 观察空间到裁剪空间：裁剪（投影）变换

投影是为了将三维空间中的点映射到二维屏幕空间上，其实就是映射到近平面上

![q1SNB](https://cdn.jsdelivr.net/gh/YuzikiRain/ImageBed/img/202208301217034.png)

#### 正交投影

设观察空间的顶点位置为$(x,y,z,1)$，变换到NDC下为$(x',y',z',1)$，将顶点从观察空间变换到裁剪空间的投影变换矩阵为$M_{orthographic->NDC}$，视锥体为[l, r] x [b, t] x [**f, n**]的立方体
$$
\left[\begin{matrix}x'\\y'\\z'\\1\end{matrix}\right]
=
M_{orthographic->NDC}
\left[\begin{matrix}x\\y\\z\\1\end{matrix}\right]
$$
可通过平移（立方体中心到远点的向量）和缩放（长宽高都为2），将顶点变换到NDC坐标系（范围都是$[-1,1]$）下

![image-20220830102526211](https://cdn.jsdelivr.net/gh/YuzikiRain/ImageBed/img/202208301025196.png)

矩阵表示如下：
$$
\begin{align}
M_{scale}M_{translate}
&= 
\left[
    \begin{matrix}
    \frac{2}{r-l} & 0 & 0 & 0\\
    0 & \frac{2}{t-b} & 0 & 0\\
    0 & 0 & \frac{2}{n-f} & 0\\
    0 & 0 & 0 & 1
    \end{matrix}
\right]
\left[
    \begin{matrix}
    1 & 0 & 0 & -\frac{l+r}{2}\\
    0 & 1 & 0 & -\frac{t+b}{2}\\
    0 & 0 & 1 & -\frac{n+f}{2}\\
    0 & 0 & 0 & 1
    \end{matrix}
\right]
\\
\end{align}
$$

-   立方体中心为$(\frac{l+r}{2},\frac{t+b}{2},\frac{n+f}{2})$，因此到原点的位移为其取反
-   $n-f$是因为我们规定裁剪空间下使用右手坐标系，$n$比$f$大，$n-f$才是正数

#### 透视投影

相同正交投影，多了一步将透视视锥体“挤压”变换到正交视锥体的变换$M_{perspective->orthographic}$
$$
\left[\begin{matrix}x'\\y'\\z'\\1\end{matrix}\right]
=
M_{orthographic->NDC}M_{perspective->orthographic}
\left[\begin{matrix}x\\y\\z\\1\end{matrix}\right]
$$
![image-20220830120610406](https://cdn.jsdelivr.net/gh/YuzikiRain/ImageBed/img/202208301206481.png)

前提：

-   $(x,y,z,1)$、$(kx,ky,kz,k) k!=0$、$(zx,zy,z^2,z) z!=0$都表示相同的点，因为后者最终可以通过对各分量同时除以w分量，转换为前者
-   只能使用$w$分量为1的齐次坐标来表示顶点位置
-   透视除法这一步通过对各分量同时除以$w$分量，会将$(kx,ky,kz,k)$重新变回$(x,y,z,1)$的形式

##### 推导xy

![image-20220830120436904](https://cdn.jsdelivr.net/gh/YuzikiRain/ImageBed/img/202208301204986.png)

**以视锥体上边缘的特定顶点$(x,y,z,1)$为例，矩阵$M_{perspective->orthographic}$也适用于该顶点**（当然也应该适用于所有顶点），近平面到相机距离为$n$

对于z，$z'=n$

对于y，顶点$(x,y,z,1)$映射到近平面上为$(x',y',z',1)$，根据相似三角形定理可得：$y/y'=z/z'$，则有$y'=ny/z$

对于x，同理可得：$x'=nx/z$

上述xyz特指某个顶点（和下述式子指代不同），而矩阵$M_{perspective->orthographic}$可推广到任意顶点

对于**任意顶点$(x,y,z,1)$**，都存在某种变换
$$
\left[\begin{matrix}x'\\y'\\z'\\1\end{matrix}\right]
=
M_{某种变换}
\left[\begin{matrix}x\\y\\z\\1\end{matrix}\right]
=
\left[\begin{matrix}nx/z\\ny/z\\z_{unknown}\\1\end{matrix}\right]
$$
**因为我们不想让xy和z之间产生联系**，因此等式两边都乘以$z$
$$
\begin{align}
z*M_{某种变换}
\left[\begin{matrix}x\\y\\z\\1\end{matrix}\right]
&=
z\left[\begin{matrix}nx/z\\ny/z\\z_{unknown}\\1\end{matrix}\right]
\\
M_{perspective->orthographic}
\left[\begin{matrix}x\\y\\z\\1\end{matrix}\right]
 &=
\left[\begin{matrix}nx\\ny\\z_{unknown}\\z\end{matrix}\right]
\end{align}
$$
**$M_{perspective->orthographic}$实际上并不会将顶点$(x,y,z,1)$变换为$(nx/z,ny/z,unknown,1)$，而是$(nx,ny,unknown,z)$**

但没关系，因为**$(nx/z,ny/z,unknown,1)$和$(nx,ny,unknown,z)$都表示同一个顶点位置**

之后透视除法会对所有分量同时除以w分量，最后得到一个$w$分量为1的可用于表示顶点位置的向量

##### 推导z

$x'$只和$x$ 有关，yw分量同理，

可得到矩阵$M_{perspective->orthographic}$的第一二四行结果
$$
M_{perspective->orthographic}=
\left[
    \begin{matrix}
    n & 0 & 0 & 0\\
    0 & n & 0 & 0\\
    C & D & A & B\\
    0 & 0 & 1 & 0
    \end{matrix}
\right]
$$
由于我们不想让$z$与$xy$有关系，这里取C和D都为0
$$
M_{perspective->orthographic}=
\left[
    \begin{matrix}
    n & 0 & 0 & 0\\
    0 & n & 0 & 0\\
    0 & 0 & A & B\\
    0 & 0 & 1 & 0
    \end{matrix}
\right]
$$
对于z分量
$$
M_{perspective->orthographic}
\left[\begin{matrix}x\\y\\z\\1\end{matrix}\right]
=
\left[
    \begin{matrix}
    n & 0 & 0 & 0\\
    0 & n & 0 & 0\\
    C & D & A & B\\
    0 & 0 & 1 & 0
    \end{matrix}
\right]
\left[\begin{matrix}x\\y\\z\\1\end{matrix}\right]
 &=
\left[\begin{matrix}nx\\ny\\z_{unknown}\\z\end{matrix}\right]
$$
**注意，$unknown_z$是未知的，不是变换后得到的近平面上的点的z分量$z'$（z’恒为n）**

###### 近平面上的点经过变换后仍保持不变

根据**近平面上的点经过变换后仍保持不变**的性质，即对于近平面某个顶点位置$(x_{near},y_{near},n,1)$，经过变换后应该得到相同的位置$(x_{near},y_{near},n,1)$，等同于$(nx_{near},ny_{near},n^2,n)$

由此可得：
$$
\left[
    \begin{matrix}
    n & 0 & 0 & 0\\
    0 & n & 0 & 0\\
    0 & 0 & A & B\\
    0 & 0 & 1 & 0
    \end{matrix}
\right]
\left[\begin{matrix}x_{near}\\y_{near}\\n\\1\end{matrix}\right]
=
\left[\begin{matrix}nx_{near}\\ny_{near}\\n^2\\n\end{matrix}\right]
$$
注意，根据之前推导得到的式子
$$
M_{perspective->orthographic}
\left[\begin{matrix}x\\y\\z\\1\end{matrix}\right]
 &=
\left[\begin{matrix}nx\\ny\\z_{unknown}\\z\end{matrix}\right]
$$
**经过变换得到的顶点位置的$w$分量应等于变换前顶点的$z$分量**

**这也是为什么等式右边不是用$(x_{near},y_{near},n,1)$而是$(nx_{near},ny_{near},n^2,n)$**

最后可得：
$$
\begin{align}
\left[
    \begin{matrix}
    0 & 0 & A & B
    \end{matrix}
\right]
\left[\begin{matrix}x_{near}\\y_{near}\\n\\1\end{matrix}\right]
&=n^2
\\
An+B&=n^2
\end{align}
$$

###### 远平面上中心点经过变换后仍保持不变

远平面到相机的距离为$f$

对于远平面中心点$(0,0,f,1)$，经过变换后仍为$(0,0,f,1)$，等同于$(0,0,f^2,f)$

根据之前推导得到的式子
$$
M_{perspective->orthographic}
\left[\begin{matrix}x\\y\\z\\1\end{matrix}\right]
 &=
\left[\begin{matrix}nx\\ny\\z_{unknown}\\z\end{matrix}\right]
$$
带入$z=f$可得：
$$
\left[
    \begin{matrix}
    n & 0 & 0 & 0\\
    0 & n & 0 & 0\\
    0 & 0 & A & B\\
    0 & 0 & 1 & 0
    \end{matrix}
\right]
\left[\begin{matrix}0\\0\\f\\1\end{matrix}\right]
=
\left[\begin{matrix}0\\0\\f^2\\f\end{matrix}\right]
$$
用$(0,0,f^2,f)$而不是$(0,0,fn,n)$来表示相同顶点$(0,0,f,1)$，是因为要符合**经过变换得到的顶点位置的$w$分量应等于变换前顶点的$z$分量**的条件，而$f$和$n$一般不相等

最后可得：
$$
\begin{align}
\left[
    \begin{matrix}
    0 & 0 & A & B
    \end{matrix}
\right]
\left[\begin{matrix}0\\0\\f\\1\end{matrix}\right]
&=f^2
\\
Af+B&=f^2
\end{align}
$$
联立方程组
$$
\begin{align}
An+B&=n^2
\\
Af+B&=f^2
\end{align}
$$
可得：$A=f+n$，$B=-nf$

带入到矩阵中可得
$$
M_{perspective->orthographic}=
\left[
    \begin{matrix}
    n & 0 & 0 & 0\\
    0 & n & 0 & 0\\
    0 & 0 & f+n & -nf\\
    0 & 0 & 1 & 0
    \end{matrix}
\right]
$$
设$aspect=\frac{r}{t}$，焦距为$fov$

$f=far$

$n=near$

$t=near\tan\frac{fov}{2}$

$b=-near\tan\frac{fov}{2}$

$r=aspect*near*\tan\frac{fov}{2}$

$l=-aspect*near*\tan\frac{fov}{2}$

带入到$M_{orthographic->NDC}M_{perspective->orthographic}$得：
$$
M_{orthographic->NDC}M_{perspective->orthographic}=\\
M_{scale}M_{translate}M_{perspective->orthographic}=\\
\left[
    \begin{matrix}
    \frac{\cot(fov/2)}{aspect*near} & 0 & 0 & 0\\
    0 & \frac{\cot(fov/2)}{near} & 0 & 0\\
    0 & 0 & \frac{2}{near-far} & 0\\
    0 & 0 & 0 & 1
    \end{matrix}
\right]
\left[
    \begin{matrix}
    1 & 0 & 0 & 0\\
    0 & 1 & 0 & 0\\
    0 & 0 & 1 & -\frac{near+far}{2}\\
    0 & 0 & 0 & 1
    \end{matrix}
\right]
\left[
    \begin{matrix}
    near & 0 & 0 & 0\\
    0 & near & 0 & 0\\
    0 & 0 & far+near & -near*far\\
    0 & 0 & 1 & 0
    \end{matrix}
\right]
\\
=
\left[
    \begin{matrix}
    \frac{\cot(fov/2)}{aspect} & 0 & 0 & 0\\
    0 & \cot(fov/2) & 0 & 0\\
    0 & 0 & \frac{near+far}{near-far} & \frac{-2near*far}{near-far}\\
    0 & 0 & 1 & 0
    \end{matrix}
\right]
$$
注意第四行为$[0,0,1,0]$，表示经过变换后，$w$分量与变换前的$z$分量有关

### 小结

**以下均发生在右手坐标系下（旋向性没有发生过变化），相机朝向$-z$方向**

$(x,y,z,1)$为观察空间下的坐标

$M_{perspective->orthographic}(x,y,z,1)^T=(x',y',z',z)=>(x'/z,y'/z,z'/z,1)$

$(x'/z,y'/z,z'/z,1)$表示裁剪空间下，从透视视锥体”挤压“到正交视锥体的顶点位置

$M_{scale}M_{translate}(x',y',z',z)^T=(x'',y'',z'',z)=>(x''/z,y''/z,z''/z,1)$

$(x'',y'',z'',z)$表示裁剪空间下，正交视锥体经过平移、缩放变换后得到的坐标（**还未进行齐次除法**），$xyz$分量**范围为$[-w,w]$**

$(x''/z,y''/z,z''/z,1)$表示裁剪空间下，NDC标准化设备坐标（**经过齐次除法之后**），$xyz$分量**范围为$[-1,1]$**

### positionCS的w分量

顶点着色器中经过变换得到的输出**`positionCS`，其w分量未经过透视除法（得到NDC下的坐标），等同于`positionVS.z`**。

常见用法是**乘以这个值（w分量）来抵消透视除法造成的近大远小**，比如法线外扩实现描边，描边宽度会跟原物体一样近大远小，如果在顶点着色器阶段乘以这个值即可实现恒定宽度的描边（更好的优化是给w限定一个范围，比如$[1, 5]$）
``` glsl
// 观察空间下，camera面朝的方向是z递减的，取绝对值方便下一步的lerp和clamp
float distance = abs(positionVS.z);
float scale = clamp(lerp(1, distance, _OutlineAjustRatio), 1, 5);
positionVS.xy += direction * _OutlineWidth * scale;
```

w分量还和深度值相关

### Unity中的投影变换

**裁剪发生在裁剪空间**中，坐标范围在$[-w,w]$之外的会被裁剪。比如观察空间下的位置坐标$(1,2,3,1)$变换到裁剪空间变为$(4,5,6,5)$，此时w分量为5，由于z分量不在$[-5,5]$范围内，因此会被裁剪

对于位置坐标来说

- 透视投影：w并不是固定值，距离摄像机越近（z越小），则w越小。观察空间$(x,y,z,1)$ -> 裁剪空间

    $$\begin{bmatrix}
     x\cdot \cot(fov/2)/aspect\\
     y\cdot \cot(fov/2)\\
     -z(far+near)/(far-near)-2(near\cdot far)(far-near)\\
     -z\end{bmatrix}$$

- 正交投影：w恒为1（因为不受裁剪变换影响）

## 深度

设深度$f(z)$**范围为$[0,1]$**

$f(z)=\frac{Az+B}{-z}$

近平面$z=n$处，深度最小：$f(z)=0$

远平面$z=f$处，深度最大：$f(z)=1$，

联立方程组
$$
\begin{align}
\frac{-An+B}{n} &= 0  \\
\frac{-Af+B}{f} &= 1  \\
\end{align}
$$
可得：$A=-\frac{f}{f-n},B=-\frac{fn}{f-n}$

带入可得：$f(z)=\frac{f}{f-n}+\frac{fn}{f-n} * \frac{1}{z}$

说明深度是关于$z$的反函数，z越大，深度越小。且近处（靠近n）深度变化快（占范围大），远处（靠近f）深度变化慢（占范围小）

### 参考

[[图形学笔记\]推导投影矩阵 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/122411512)

## 矩阵

在Unity中，对矢量进行矩阵变换通常是把**矩阵放左边,矢量放右边**（将矢量作为列矩阵），称为对矢量左乘一个矩阵
计算顺序为从右到左，即 $CBAv = (C(B(Av)))$，
看起来运算顺序是先**A**然后**B**再**C**，但其实也可以先计算$(CBA)v$。

一般说将矢量看作列矩阵进行矩阵变换时阅读顺序时从右到左，这种说法是不准确的。假设分别有3个变换矩阵$M$（模型空间到世界空间）$V$（世界空间到观察空间）$P$（观察空间到裁剪空间）。那么

- $(P(V(Mv)))$：表示将矢量$v$从模型空间变换到世界空间，再到观察空间，再到裁剪空间，这时候可以在$v$处于不同空间下做不同的处理
- $(PVM)v$：$(PVM)$表示从从模型空间到世界空间再到观察空间再到裁剪空间的一系列变换组合而成的矩阵，不关心中间的过程

Cg对于矩阵类型的变量是按照**行优先**的方式进行填充的，也就是说，对于代码```float3 normal : NORMAL;```中的normal变量来说，用代码```normal = (1.0, 1.0, 1.0);```初始化normal变量，只是按行优先的方式填充数据，这些数据都是**一维**的，并**不代表normal是行矩阵或是列矩阵**。
**在矢量normal与矩阵相乘时，它与矩阵的相乘顺序才决定了函数将其视为行矩阵还是列矩阵来运算（因为矩阵相乘需满足左矩阵列数 = 右矩阵行数）**

```glsl
float3 normal = (1.0, 1.0, 1.0);
// normal会被当做列矩阵（按列展开，3行1列）
float3 columnMatrix = mul((float3x3)unity_WorldToObject, normal)
// normal会被当做行矩阵（按行展开，1行3列）
float3 rowMatrix = mul(normal, (float3x3)unity_WorldToObject)
```

**mul函数的返回值float3仍是一维数据**，根据该变量在函数中的参数顺序（与矩阵相乘的相对顺序）决定将其视为行矩阵或列矩阵

### 法线变换矩阵

如果使用变换顶点位置的M矩阵来变换法线，当M矩阵包含非统一缩放（或其他任何非线性变换）时，

假设在平面XY上，$scale=(1,2)$，那么模型空间下的顶点$A=(1,2)$和顶点$B=(2,1)$以及垂直于AB的法线$N=(1,1)$会变成$A'=(1,4)$和顶点$B'=(2,2)$以及$N'=(1,2)$，然而垂直于A'B'的法线应该为$(2,1)$才对

显然，法线这种表示方向的向量不应该直接像变换顶点一样，应该是由变换后的平面来决定的。比如任取平面上的三个点，组成2个向量，求叉积即可表示平面的法向量即法线。

### 推导

设$M$为模型矩阵，$G$为要求的将法线从本地空间变换到世界空间的**4×4的矩阵（方阵，满足行数和列数相等）**

本地空间：法线$N$、切线$T$，切线$T$上的两点$P_1$和$P_2$

世界空间：分别为$N'$、$T'$、$P_1'$、$P_2'$

由于$N$和$T$垂直，$N'$和$T'$垂直，由点积公式可得

$N \cdot T = 0$

$N' \cdot T' = 0$

将对应向量都扩展为四维向量（对于第四个分量，向量表示位置则设为1，方向则设为0），然后就可以与矩阵一起参与运算。

从第二个式子到第三个式子，是因为点乘可以使用结合律。最后证明可用$M$矩阵将$T$变换到$T'$（但$N$不行）
$$
\begin{align}
T &= P_2 - P_1 \tag{1} \\
MT &= M(P_1-P_2) \tag{2} \\ 
MT &= MP_1-MP_2 \tag{3} \\ 
MT &= P_1'-P_2' \tag{4} \\
MT &= T'
\end{align}
$$
$GN=N'$

$MT=T'$

假设这些一维向量$N$、$T$都是列向量，则$N' \cdot T'$和$N \cdot T$可表示为两个矩阵相乘（左列数等于右行数，要将列矩阵$N'$和$N$进行转置变为行矩阵） ，结果为一个1×1的零矩阵，其唯一元素就是结果0
$$
\begin{align}
N^T T &= N \cdot T \tag{1}\\
N^T T &= 0 \tag{2}\\
\end{align}
$$

$$
\begin{align}
(N')^T T' &= N' \cdot T' \tag{1} \\
(GN)^T MT &= 0 \tag{2} \\ 
N^T G^T MT &= 0 \tag{3} \\ 
\end{align}
$$
假如$G^T M$ 为单位矩阵，即 $G^T M=I$，则上述式子成立。（零矩阵也成立，且零矩阵也是单位矩阵）

根据逆矩阵的性质，（如果G是一个方阵）则有$G G^{-1}=I$，带入上述式子得$G^T=M^{-1}$，$G=(M^{-1})^T$（矩阵的转置的转置等于原矩阵）

最后得到，$G=(M^{-1})^T$
