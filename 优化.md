### 优先级

**SRP Batcher > Static Batch > GPU Instancing > Dynamic Batch**

### 支持合批

|                | 多pass                   | MaterialPropertyBlock | 修改material（产生material实例） |
| -------------- | ------------------------ | --------------------- | -------------------------------- |
| SRP batcher    | ❌                        | ❌                     | ✔️                                |
| Static Batch   |                          |                       |                                  |
| GPU Instancing | **只能实例化第一个通道** | ✔️                     | ❌                                |
| Dynamic Batch  | ❌                        | ✔️                     | ❌                                |

只有SRP batcher可以对material实例进行合批，其他方式都必须要用同一个sharedMaterial

#### SRP batcher

##### 限制

- 不能使用多pass（比如使用其他Tag `"LightMode" = "SRPDefault"`来支持多pass），否则每个pass都会产生一个draw call，多个（使用了该shader的）物体之间都无法合批（比如2个pass，2个物体，FrameDebugger里仍会显示4个SRP Batch）
- 不能使用MaterialPropertyBlock，否则也会打断合批（此时会走Dynamic batching看看能不能合批）
    替代方案
    - GPU Instancing + MaterialPropertyBlock
    - 通过 `GetComponent<MeshRenderer>().material.SetFloat("_Cutoff", 0.555f);`来修改材质实例，虽然会生成多个材质实例，但是SRP Batcher会能对这些材质进行合批处理

#### Static batching

- 无法修改Transform组件的任何属性（因为这些属性都被事先保存起来了，这也会导致包体、内存占用变大）
- 如果多个GameObject在静态批处理之前共享相同的几何图形，则在编辑器或运行时为每个GameObject创建一个几何图形副本
    因此如果此场景中存在大量这样的GameObject，应该考虑使用GPU Instancing

#### Dynamic batching

- Unity将小网格物体动态合并在一起，难以预测，有极大限制（顶点限制）
- 无法处理多pass

##### 限制

- 不能使用多pass（比如使用其他Tag `"LightMode" = "SRPDefault"`来支持多pass），否则每个pass都会产生一个draw call，多个（使用了该shader的）物体之间都无法合批（比如2个pass，2个物体，FrameDebugger里仍会显示4个SRP Batch）
    参考：https://forum.unity.com/threads/batching-disabled-to-avoid-z-fighting.525065/

## 变体

（使用自定义的变体收集器脚本）找出不用的关键字并删除

### 参考

- https://docs.unity3d.com/Manual/DrawCallBatching.html
- [关于静态批处理/动态批处理/GPU Instancing /SRP Batcher的详细剖析](https://zhuanlan.zhihu.com/p/98642798)
- [UWA2020(一)_Unity移动游戏项目优化案例分析（上）](https://zhuanlan.zhihu.com/p/261378070)
- [【Unity游戏开发】马三的游戏性能优化自留地 - 马三小伙儿 - 博客园 (cnblogs.com)](https://www.cnblogs.com/msxh/p/12987632.html)
- [Unity - 手动：选择和配置渲染管线和光照解决方案 (unity3d.com)](https://docs.unity3d.com/Manual/BestPracticeLightingPipelines.html)
